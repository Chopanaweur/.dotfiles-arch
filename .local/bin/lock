#!/usr/bin/env python3

"""Lock scripts which doesn't trigger if you're connected to your home network.

On lock it also sends a dbus message to KeePassXC to lock the database
(so nothing that stays in memory).
"""

import os
import sys
from subprocess import run, PIPE

WALLPAPER = os.environ["HOME"] + "/.local/share/wallpaper.jpg"

# Get your router mac address using "ip neighbor"
HOME_NETWORK_MAC = "50:6f:0c:73:22:b0"  # CHANGEME


def lock_keepassxc() -> None:
    run(
        [
            "/usr/bin/dbus-send",
            "--print-reply",
            "--dest=org.keepassxc.KeePassXC.MainWindow",
            "/keepassxc",
            "org.keepassxc.KeePassXC.MainWindow.lockAllDatabases",
        ],
        check=True,
        stdout=PIPE,
        stderr=PIPE,
    )


def lock_desktop() -> None:
    run(
        [
            "/usr/bin/swaylock",
            "--daemonize",
            "--ignore-empty-password",
            "--image",
            WALLPAPER,
        ],
        check=True,
        stdout=PIPE,
        stderr=PIPE,
    )


def is_connected_to_home_network() -> bool:
    proc = run(
        ["/usr/bin/ip", "neighbor"],
        check=True,
        stdout=PIPE,
        stderr=PIPE,
    )

    return HOME_NETWORK_MAC in proc.stdout.decode()


def main() -> None:
    if len(sys.argv) == 2:
        force_lock = sys.argv[1] == "--force"
    else:
        force_lock = False

    if force_lock or not is_connected_to_home_network():
        lock_keepassxc()
        lock_desktop()


if __name__ == "__main__":
    main()
